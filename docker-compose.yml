services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: backend
    env_file:
      - ./backend/.env
    environment:
      STAGE: prod
      API_HOST: 0.0.0.0
      API_PORT: 8080
      SITE_URL: https://localhost
      DATABASE_URL: postgresql+asyncpg://postgres:secret@db:5432/hackathon
      REDIS_URL: redis://redis:6379/0
      SITE_URL: https://68fb161ab7e72a5feaf4dc52--codemetricsproto.netlify.app
      API_URL: "https://gateway-codemetrics.saas.sferaplatform.ru/app/sourcecode/api/api/v2/"
      CSRF_HMAC_KEY: f8bgBKV8FDlKsMrN98b5ClblJUOPa7jWdoPd0mj00G8
      API_USERNAME: laughinmee@gmail.com
      API_PASSWORD: bfvWZhVD8RDX
      JWT_PRIVATE_KEY: "-----BEGIN PRIVATE KEY-----\n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\nEItGHVjxb/m/ONhkJm5de5VgIQhfGhQC\n-----END PRIVATE KEY-----"
      JWT_PUBLIC_KEY: "-----BEGIN PUBLIC KEY-----\nMIICIjANBgkqhkiG9w0BAQEFAAOCAg8AMIICCgKCAgEA1CnK93Xka92hw3e+TPT2\ngzvP9CjTmzl9q0+VvsWtVaS9c3bF8bGHfiOsxAEx0I94HPXQGqxumuk2EhBlDWBL\nkh3lq3+xpbG8EnAjqlwaQEfxba5GCNuP/zkDB1JT+zd07BysUFOckBBcLSLVDNQ8\nNfWQvhPTZJQAhcjbJMnoepKroIKd3nFC8QmdVe/CNnTjEiVtxFl7/OGio5RmWOyX\nLtFRUkM5uM30h8BIawWSYqFcToZOu3rIdfNU4Ve3z7GKmF7gXNpGxp2Q7mTCn2d8\nzW1kIjdlLwgn9gNt7sr/jE6yCMMiKDnKy7dvXZZXbz+vVBwnmyITyclAN+7hPe9A\nshgDZ8/XzkutZym3+zYDhDnBlWcXmvuIaW7YECaPjbUv1ihNq8rXB4JbRyoC47fp\nJ2p+BIbrG7JLiTOH6QO9lEacU9RLgvY7ML/IbCupEcxgcKSawGal0hT/LwotWeEx\nu4BHEEN9ATMU7gbA62KWMCnXf/q9LAEZD+Ow8GO1BZhAKABuT+ItLxHPyXky2XFX\n1+L3pZMZdNNTSFw8Ap2fAOLBXZRNzS2YYu4+dihQ5GuHSIP3dWuYHcMFt4omnkcr\nxHQG7v3wPAkVU976Xt2hO2WKRw60Cl0PclfNPIRO4PLsPwH0AQLujPGwV2s+8rr7\ne+La86RCC9MH79DkbrN9tb8CAwEAAQ==\n-----END PUBLIC KEY-----"
      


    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped

  nginx:
    build:
      context: .
      dockerfile: nginx/Dockerfile
      args:
        VITE_API_BASE_URL: https://localhost
        VITE_ENABLE_HTTPS: "false"
    container_name: nginx
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      backend:
        condition: service_started
    restart: unless-stopped

  db:
    image: postgres:16-alpine
    container_name: postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: secret
      POSTGRES_DB: hackathon
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: redis_service
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    restart: unless-stopped

volumes:
  postgres_data:
  redis_data:
